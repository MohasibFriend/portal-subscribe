<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ØµÙØ­Ø© Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ</title>
  <style>
    /* ==== Variables & Base ==== */
    :root {
      --color-bg-start: #E0E7FF;
      --color-bg-end: #FFFFFF;
      --color-primary: #4F46E5;
      --color-secondary: #10B981;
      --color-accent: #6366F1;
      --color-light: #bcbcf1;
      --color-dark: #1F2937;
      --radius: 12px;
      --transition: 0.3s ease;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, var(--color-bg-start), var(--color-bg-end));
      color: var(--color-dark);
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 40px 20px;
      min-height: 100vh;
    }

    /* ==== Plan Cards ==== */
    .plans {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 24px;
      width: 100%;
      max-width: 900px;
      margin-bottom: 40px;
    }

    .plan-card {
      background: #FFF;
      border-radius: var(--radius);
      box-shadow: 0 4px 20px rgba(31, 41, 55, 0.05);
      padding: 24px;
      text-align: center;
      cursor: pointer;
      transition: transform var(--transition),
        box-shadow var(--transition),
        opacity var(--transition),
        border-color var(--transition);
      opacity: 0.7;
      border: 2px solid transparent;
    }

    .plan-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 6px 24px rgba(31, 41, 55, 0.1);
      opacity: 1;
    }

    .plan-card.active {
      opacity: 1;
      border-color: var(--color-primary);
      transform: translateY(-5px);
      box-shadow: 0 8px 28px rgba(31, 41, 55, 0.15);
    }

    .plan-card h2 {
      margin-bottom: 12px;
      font-size: 1.4rem;
      color: var(--color-primary);
    }

    .plan-card .price {
      font-size: 1.8rem;
      margin: 8px 0;
      font-weight: bold;
      color: var(--color-dark);
    }

    .plan-card ul {
      list-style: none;
      padding: 0;
      margin: 16px 0;
      text-align: right;
      color: var(--color-dark);
    }

    .plan-card ul li {
      margin: 6px 0;
      position: relative;
      padding-left: 20px;
    }

    .plan-card ul li::before {
      content: 'âœ”';
      position: absolute;
      left: 0;
      color: var(--color-secondary);
      font-size: 0.9rem;
      top: 0;
    }

    .plan-card .savings {
      font-size: 0.9rem;
      color: var(--color-secondary);
    }

    /* ==== Form ==== */
    .form-container {
      background: #FFF;
      border-radius: var(--radius);
      box-shadow: 0 4px 20px rgba(31, 41, 55, 0.05);
      padding: 30px;
      width: 100%;
      max-width: 500px;
      border: #000 solid 2px;
    }

    .input-group {
      display: flex;
      align-items: center;
      margin-bottom: 16px;
      gap: 12px;
    }

    .input-group label {
      min-width: 100px;
      font-weight: 500;
      color: var(--color-dark);
    }

    .input-group input {
      flex: 1;
      padding: 10px 12px;
      border: 2px solid #D1D5DB;
      border-radius: 8px;
      font-size: 1rem;
      transition: border-color var(--transition);
    }

    .input-group input:focus {
      outline: none;
      border-color: var(--color-primary);
    }

    .input-group .remove-btn {
      background: var(--color-secondary);
      border: none;
      border-radius: 6px;
      padding: 6px 10px;
      color: white;
      cursor: pointer;
      transition: background var(--transition);
    }

    .input-group .remove-btn:hover {
      background: #059669;
    }

    .form-actions {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 24px;
    }

    .form-actions button {
      padding: 12px 24px;
      font-size: 1rem;
      border: none;
      border-radius: var(--radius);
      cursor: pointer;
      transition: background var(--transition), transform var(--transition);
    }

    #addEmailBtn {
      background: var(--color-secondary);
      color: #FFF;
      font-weight: bold;
    }

    #addEmailBtn:disabled {
      background: #A3A3A3;
      cursor: not-allowed;
    }

    #addEmailBtn:hover:not(:disabled) {
      background: #059669;
      transform: translateY(-2px);
      font-weight: bold;
    }

    #confirmBtn {
      background: var(--color-accent);
      color: #FFF;
      font-weight: bold;
    }

    #confirmBtn:hover {
      background: #4F46E5;
      transform: translateY(-2px);
      font-weight: bold;
    }

    /* ==== Overlays & Spinner ==== */
    .overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.4);
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }

    .spinner {
      width: 70px;
      height: 70px;
      border: 8px solid #F3F4F6;
      border-top: 8px solid var(--color-accent);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    .message-box {
      background: white;
      border-radius: 12px;
      padding: 60px;
      text-align: center;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      width: 40%;
      max-width: 161px;
    }

    .message-box .icon {
      font-size: 3rem;
      margin-bottom: 8px;
    }

    .success-icon {
      color: var(--color-secondary);
    }

    .error-icon {
      color: #DC2626;
    }

    .message-box button {
      margin-top: 16px;
      padding: 10px 20px;
      border: none;
      border-radius: var(--radius);
      cursor: pointer;
      background: var(--color-primary);
      color: #FFF;
      font-size: 1rem;
      transition: background var(--transition);
    }

    .message-box button:hover {
      background: #4338CA;
    }
  </style>
</head>

<body>
  <div class="plans">
    <div id="monthlyPlan" class="plan-card active">
      <h2>Ø§Ø´ØªØ±Ø§Ùƒ Ø´Ù‡Ø±ÙŠ</h2>
      <p class="price">114 Ø¬.Ù… / Ø´Ù‡Ø±</p>
      <ul>
        <li>10 Ø§ÙŠÙ…ÙŠÙ„Ø§Øª Ù‡Ø¯ÙŠØ©</li>
        <li>ØªØ­Ù…ÙŠÙ„ Ø³Ø±ÙŠØ¹</li>
      </ul>
    </div>
    <div id="yearlyPlan" class="plan-card">
      <h2>Ø§Ø´ØªØ±Ø§Ùƒ Ø³Ù†ÙˆÙŠ</h2>
      <p class="price">684 Ø¬.Ù… / Ø³Ù†Ø©</p>
      <ul>
        <li>20 Ø§ÙŠÙ…ÙŠÙ„ Ù‡Ø¯ÙŠØ©</li>
        <li>ØªØ­Ù…ÙŠÙ„ Ø£Ø³Ø±Ø¹ ÙˆØ£Ø±Ø®Øµ</li>
      </ul>
      <p class="savings"></p>
    </div>
  </div>

  <div class="form-container" id="formContainer">
    <div class="input-group">
      <label for="phoneInput">Ø±Ù‚Ù… Ø§Ù„ØªÙ„ÙÙˆÙ†:</label>
      <input type="text" id="phoneInput" placeholder="Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„ØªÙ„ÙÙˆÙ†">
    </div>
    <div class="input-group">
      <label for="primaryEmailInput">Ø§Ù„Ø§ÙŠÙ…ÙŠÙ„ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ:</label>
      <input type="email" id="primaryEmailInput" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ø§ÙŠÙ…ÙŠÙ„ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ">
    </div>
    <div id="additionalEmails"></div>
    <div class="form-actions">
      <button id="addEmailBtn">Ø¥Ø¶Ø§ÙØ© Ø§ÙŠÙ…ÙŠÙ„</button>
      <button id="confirmBtn">ØªØ£ÙƒÙŠØ¯</button>
    </div>
  </div>

  <div id="spinnerOverlay" class="overlay">
    <div class="spinner"></div>
  </div>
  <div id="successOverlay" class="overlay">
    <div class="message-box">
      <div class="icon success-icon">âœ”ï¸</div>
      <p>ØªÙ…Øª Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ø¨Ù†Ø¬Ø§Ø­</p>
      <button id="successOkBtn">Ø­Ø³Ù†Ø§Ù‹</button>
    </div>
  </div>
  <div id="errorOverlay" class="overlay">
    <div class="message-box">
      <div class="icon error-icon">âŒ</div>
      <p>ÙØ´Ù„Øª Ø§Ù„Ø¹Ù…Ù„ÙŠØ©</p>
      <button id="errorOkBtn">Ø­Ø³Ù†Ø§Ù‹</button>
    </div>
  </div>

  <script>
    // Ø­Ø³Ø§Ø¨ Ø§Ù„Ø®ØµÙ… Ø§Ù„Ø³Ù†ÙˆÙŠ
    const monthlyPrice = 114;
    const yearlyPrice = 684;
    const annualFull = monthlyPrice * 12;
    const discount = annualFull - yearlyPrice;
    const percentDisc = Math.round((discount / annualFull) * 100);
    document.querySelector('#yearlyPlan .savings').textContent =
      `ÙˆÙØ± ${discount} Ø¬.Ù… (${percentDisc}%)`;

    // Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø®Ø·Ø·
    let currentPlan = 'monthly';
    const maxEmails = { monthly: 10, yearly: 20 };

    const monthlyCard = document.getElementById('monthlyPlan');
    const yearlyCard = document.getElementById('yearlyPlan');
    const addEmailBtn = document.getElementById('addEmailBtn');
    const extrasContainer = document.getElementById('additionalEmails');
    const confirmBtn = document.getElementById('confirmBtn');
    const spinnerOverlay = document.getElementById('spinnerOverlay');
    const successOverlay = document.getElementById('successOverlay');
    const errorOverlay = document.getElementById('errorOverlay');
    const plansEl = document.querySelector('.plans');
    const formEl = document.getElementById('formContainer');

    function selectPlan(plan) {
      currentPlan = plan;
      monthlyCard.classList.toggle('active', plan === 'monthly');
      yearlyCard.classList.toggle('active', plan === 'yearly');
      // Ø¥Ø²Ø§Ù„Ø© Ø²ÙŠØ§Ø¯Ø§Øª Ù„Ùˆ Ø¹Ø¯ÙˆØ§ Ø§Ù„Ø­Ø¯
      const groups = extrasContainer.querySelectorAll('.email-group');
      const allowed = maxEmails[plan] - 1;
      groups.forEach((g, i) => { if (i >= allowed) g.remove(); });
      updateAddButton();
    }
    monthlyCard.addEventListener('click', () => selectPlan('monthly'));
    yearlyCard.addEventListener('click', () => selectPlan('yearly'));

    function updateAddButton() {
      const extrasCount = extrasContainer.querySelectorAll('.email-group').length;
      addEmailBtn.disabled = (extrasCount + 1) >= maxEmails[currentPlan];
    }
    addEmailBtn.addEventListener('click', () => {
      const div = document.createElement('div');
      div.className = 'input-group email-group';
      div.innerHTML = `
        <label>Ø§ÙŠÙ…ÙŠÙ„ Ø¥Ø¶Ø§ÙÙŠ</label>
        <input type="email" placeholder="Ø£Ø¯Ø®Ù„ Ø§ÙŠÙ…ÙŠÙ„ Ø¥Ø¶Ø§ÙÙŠ">
        <button class="remove-btn">-</button>
      `;
      extrasContainer.appendChild(div);
      div.querySelector('.remove-btn').onclick = () => {
        div.remove();
        updateAddButton();
      };
      updateAddButton();
    });

    // Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ ØªØ£ÙƒÙŠØ¯ â†’ Ø­ÙØ¸ Ø§Ù„Ø¨Ø§ÙŠÙ„ÙˆØ¯ ÙÙŠ sessionStorage Ø«Ù… Ø§Ù„Ø¯ÙØ¹
    confirmBtn.addEventListener('click', async () => {
      const phone = document.getElementById('phoneInput').value.trim();
      const primaryEmail = document.getElementById('primaryEmailInput').value.trim();
      if (!phone || !primaryEmail) {
        alert('ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø±Ù‚Ù… Ø§Ù„ØªÙ„ÙÙˆÙ† ÙˆØ§Ù„Ø§ÙŠÙ…ÙŠÙ„ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ');
        return;
      }
      const extraEmails = [...extrasContainer.querySelectorAll('input')]
        .map(i => i.value.trim()).filter(e => e);
      const dayStatusVal = currentPlan === 'monthly' ? 30 : 360;
      const payload = { primaryEmail, additionalEmails: extraEmails, dayStatus: dayStatusVal };
      sessionStorage.setItem('subscribePayload', JSON.stringify(payload));

      spinnerOverlay.style.display = 'flex';
      try {
        const res = await fetch(
          'https://ul5i2a4nke.execute-api.us-east-1.amazonaws.com/prod/subscribe-extintion',
          {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ phone, plan: currentPlan, emails: [primaryEmail, ...extraEmails] })
          }
        );
        const env = await res.json();
        const data = env.body ? JSON.parse(env.body) : env;
        spinnerOverlay.style.display = 'none';
        if (data.url) {
          window.location.href = data.url;
        } else {
          alert('Ù„Ù… ÙŠØªÙ… Ø§Ø³ØªÙ„Ø§Ù… Ø±Ø§Ø¨Ø· Ø§Ù„Ø¯ÙØ¹');
        }
      } catch (e) {
        console.error(e);
        spinnerOverlay.style.display = 'none';
        alert('Ø®Ø·Ø£ ÙÙŠ Ø§ØªØµØ§Ù„ Ø§Ù„Ø®Ø§Ø¯Ù…');
      }
    });

    // Ø¨Ø¹Ø¯ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ù…Ù† ØµÙØ­Ø© Ø§Ù„Ø¯ÙØ¹
    window.addEventListener('DOMContentLoaded', () => {
      const params = new URLSearchParams(window.location.search);
      if (params.get('type') === 'ChargeResponse') {
        plansEl.style.display = 'none';
        formEl.style.display = 'none';
        spinnerOverlay.style.display = 'flex';
        setTimeout(() => {
          spinnerOverlay.style.display = 'none';
          if (params.get('statusCode') === '200') {
            successOverlay.style.display = 'flex';
            // Ø¥Ø±Ø³Ø§Ù„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£ÙŠØ§Ù…
            const stored = sessionStorage.getItem('subscribePayload');
            if (stored) {
              const payload = JSON.parse(stored);
              console.log('ğŸ“¤ subscribe-day payload:', payload);
              fetch(
                'https://ul5i2a4nke.execute-api.us-east-1.amazonaws.com/prod/subscribe-day',
                {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify(payload)
                }
              )
              .then(res => console.log('ğŸ“¥ status', res.status))
              .catch(err => console.error('ğŸš¨ subscribe-day error:', err))
              .finally(() => sessionStorage.removeItem('subscribePayload'));
            } else {
              console.error('ğŸš¨ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ sessionStorage');
            }
          } else {
            errorOverlay.style.display = 'flex';
          }
        }, 800);
      }
    });

    document.getElementById('successOkBtn').onclick = () => {
      window.location.href = 'https://invoicing.eta.gov.eg/documents';
    };
    document.getElementById('errorOkBtn').onclick = () => {
      window.location.href = window.location.origin + window.location.pathname;
    };

    updateAddButton();
  </script>
</body>

</html>
